/* osgCompute - Copyright (C) 2008-2009 SVT Group
 *                                                                     
 * This library is free software; you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 3 of
 * the License, or (at your option) any later version.
 *                                                                     
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of 
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesse General Public License for more details.
 *
 * The full license is in LICENSE file included with this distribution.
*/

#ifndef OSGCOMPUTE_PROCESSORBIN
#define OSGCOMPUTE_PROCESSORBIN 1

#include <osg/ref_ptr>
#include <osg/Object>
#include <osg/Drawable>
#include <osg/NodeVisitor>
#include "osgCompute/Export"
#include "osgCompute/Callback"
#include "osgCompute/Module"

namespace osgCompute
{
    class Processor;
    class ProcessorBin;

    typedef std::map<osg::NodeVisitor*, osg::ref_ptr<ProcessorBin> >                          BinMap;
    typedef std::map<osg::NodeVisitor*, osg::ref_ptr<ProcessorBin> >::iterator                BinMapItr;
    typedef std::map<osg::NodeVisitor*, osg::ref_ptr<ProcessorBin> >::const_iterator          BinMapCnstItr;


    typedef std::map< std::string, osg::ref_ptr<osgCompute::Param> >                         HandleToParamMap;
    typedef std::map< std::string, osg::ref_ptr<osgCompute::Param> >::iterator               HandleToParamMapItr;
    typedef std::map< std::string, osg::ref_ptr<osgCompute::Param> >::const_iterator         HandleToParamMapCnstItr;

    /**
    */
    class LIBRARY_EXPORT ProcessorBin : public osg::Drawable 
    {
    public:
        ProcessorBin() : osg::Drawable() { clearLocal(); }  

        META_Object( osgCompute, ProcessorBin )
        
        virtual bool init( Processor& processor );

        virtual void drawImplementation( osg::RenderInfo& renderInfo ) const;

        virtual bool hasModule( const std::string& moduleName ) const;
        virtual bool hasModule( Module& module ) const;
        virtual bool hasModules() const;
        virtual Module* getModule( const std::string& moduleName );
        virtual const Module* getModule( const std::string& moduleName ) const;
        virtual ModuleList* getModules();
        virtual const ModuleList* getModules() const;
        virtual unsigned int getNumModules() const;

        inline void setContext( Context& context );
        inline Context* getContext();
        inline const Context* getContext() const;
        inline bool isDirty() const;
        inline Processor* getProcessor();
        inline const Processor* getProcessor() const;
        inline LaunchCallback* getLaunchCallback();
        inline const LaunchCallback* getLaunchCallback() const;

        inline void enable();
        inline void disable();
        inline bool isEnabled() const;

        virtual void clear();

    protected:
        friend class Processor;
        virtual ~ProcessorBin() { clearLocal(); }
        void clearLocal();

        virtual void clear( const Context& context ) const;

        virtual void launch() const;

        // members
        bool                                 _enabled;
        Processor*                            _processor;  
        bool                                 _dirty;
        LaunchCallback*                      _launchCallback;
        ModuleList                           _modules;
        HandleToParamMap                     _paramHandles; 
        mutable osg::ref_ptr<Context>        _context;               

    private:
        // copy constructor and operator should not be called
        ProcessorBin(const ProcessorBin&, const osg::CopyOp& ) {}
        inline ProcessorBin &operator=(const ProcessorBin &) { return *this; }
    };

    /////////////////////////////////////////////////////////////////////////////////////////////////
    // PUBLIC FUNCTIONS /////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////
    //------------------------------------------------------------------------------
    inline bool ProcessorBin::isDirty() const
    { 
        return _dirty; 
    }

    //------------------------------------------------------------------------------
    inline Processor* ProcessorBin::getProcessor()
    { 
        if( isDirty() )
            return NULL;

        return _processor; 
    }

    //------------------------------------------------------------------------------
    inline const Processor* ProcessorBin::getProcessor() const
    { 
        if( isDirty() )
            return NULL;

        return _processor; 
    }

    //------------------------------------------------------------------------------
    inline LaunchCallback* ProcessorBin::getLaunchCallback()
    { 
        if( isDirty() )
            return NULL;

        return _launchCallback; 
    }

    //------------------------------------------------------------------------------
    inline const LaunchCallback* ProcessorBin::getLaunchCallback() const
    { 
        if( isDirty() )
            return NULL;

        return _launchCallback; 
    }

    //------------------------------------------------------------------------------
    inline void ProcessorBin::enable() 
    { 
        _enabled = true; 
    }

    //------------------------------------------------------------------------------
    inline void ProcessorBin::disable() 
    { 
        _enabled = false; 
    }

    //------------------------------------------------------------------------------
    inline bool ProcessorBin::isEnabled() const
    {
        if( isDirty() )
            return false;

        return _enabled;
    }

    //------------------------------------------------------------------------------
    inline void ProcessorBin::setContext( Context& context )
    {
        _context = &context;
    }

    //------------------------------------------------------------------------------
    inline Context* ProcessorBin::getContext()
    {
        return _context.get();
    }

    //------------------------------------------------------------------------------
    inline const Context* ProcessorBin::getContext() const
    {
        return _context.get();
    }
}

#endif //OSGCOMPUTE_PROCESSORBIN
